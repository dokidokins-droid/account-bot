# Account Distribution Bot

## Telegram-бот для автоматизированного распределения ресурсов

---

## Обзор проекта

**Account Bot** — это корпоративный Telegram-бот для управления распределением аккаунтов, почт, номеров телефонов и прокси между сотрудниками с полной интеграцией Google Sheets.

### Ключевые возможности

| Функция | Описание |
|---------|----------|
| **Аккаунты** | Выдача аккаунтов VK, Mamba, OK, Gmail с отслеживанием статуса |
| **Почты** | Управление Gmail и Rambler почтами |
| **Номера** | Распределение номеров телефонов для Beboo, Loloo, Табор |
| **Прокси** | Добавление и получение HTTP/SOCKS5 прокси с резервированием |
| **Статистика** | Детальная аналитика по регионам и периодам |
| **Whitelist** | Система авторизации с одобрением админом |

---

## Архитектура системы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              TELEGRAM API                                │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           AIOGRAM 3.x DISPATCHER                         │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     WhitelistMiddleware                          │    │
│  │              (Проверка авторизации на каждый запрос)             │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
           ┌─────────────────────────┼─────────────────────────┐
           ▼                         ▼                         ▼
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│    HANDLERS     │      │     STATES      │      │   KEYBOARDS     │
│                 │      │                 │      │                 │
│ • start.py      │      │ • FSM States    │      │ • callbacks.py  │
│ • account_flow  │◄────►│ • Registration  │◄────►│ • inline.py     │
│ • email_flow    │      │ • AccountFlow   │      │ • number_kb     │
│ • numbers.py    │      │ • EmailFlow     │      │ • proxy_kb      │
│ • proxy.py      │      │ • ProxyFlow     │      │ • email_kb      │
│ • admin.py      │      │ • BufferStates  │      │                 │
│ • statistic.py  │      │                 │      │                 │
└─────────────────┘      └─────────────────┘      └─────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              SERVICES LAYER                              │
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ AccountCache │  │  EmailCache  │  │ NumberCache  │  │  ProxyCache  │ │
│  │              │  │              │  │              │  │              │ │
│  │  available   │  │  available   │  │  available   │  │  available   │ │
│  │  pending     │  │  pending     │  │  pending     │  │  reserved    │ │
│  │  write_buf   │  │  write_buf   │  │  issued_cache│  │  pending     │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │
│         │                 │                 │                 │         │
│         └─────────────────┴─────────────────┴─────────────────┘         │
│                                    │                                     │
│                                    ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        SheetsService                             │    │
│  │                    (Rate Limited: 1.5 req/s)                     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐                                     │
│  │ WhitelistSvc │  │  RegionSvc   │                                     │
│  │  (JSON file) │  │  (JSON file) │                                     │
│  └──────────────┘  └──────────────┘                                     │
└─────────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           GOOGLE SHEETS API                              │
│                                                                          │
│   ┌─────────────────────────┐    ┌─────────────────────────┐            │
│   │   SPREADSHEET_ACCOUNTS  │    │   SPREADSHEET_ISSUED    │            │
│   │                         │    │                         │            │
│   │  • ВКонтакте            │    │  • ВКонтакте_Выдано     │            │
│   │  • Мамба Муж/Жен        │    │  • Мамба_Выдано         │            │
│   │  • Одноклассники        │    │  • Gmail_Выдано         │            │
│   │  • Gmail                │    │  • Номера_Выдано        │            │
│   │  • Номера               │    │  • Прокси               │            │
│   └─────────────────────────┘    └─────────────────────────┘            │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Структура проекта

```
account_bot/
├── bot/
│   ├── main.py                 # Точка входа
│   ├── config.py               # Конфигурация
│   │
│   ├── models/                 # Модели данных
│   │   ├── enums.py            # Resource, Gender, Status, etc.
│   │   ├── account.py          # VK, Mamba, OK, Gmail аккаунты
│   │   ├── proxy.py            # Модель прокси
│   │   └── user.py             # Модель пользователя
│   │
│   ├── services/               # Бизнес-логика
│   │   ├── sheets_service.py   # Google Sheets API + Rate Limiter
│   │   ├── account_service.py  # Кэш аккаунтов
│   │   ├── email_service.py    # Кэш почт
│   │   ├── number_service.py   # Кэш номеров
│   │   ├── proxy_service.py    # Управление прокси
│   │   ├── whitelist_service.py# Авторизация
│   │   └── region_service.py   # Регионы
│   │
│   ├── handlers/               # Обработчики команд
│   │   ├── start.py            # /start, регистрация
│   │   ├── account_flow.py     # Выдача аккаунтов
│   │   ├── email_flow.py       # Выдача почт
│   │   ├── numbers.py          # Выдача номеров
│   │   ├── proxy.py            # Работа с прокси
│   │   ├── feedback.py         # Обработка feedback
│   │   ├── statistic.py        # Статистика
│   │   └── admin.py            # Админ-команды
│   │
│   ├── keyboards/              # Inline-клавиатуры
│   ├── middlewares/            # Middleware (auth)
│   ├── states/                 # FSM состояния
│   └── utils/                  # Утилиты
│
├── data/                       # Локальные данные (git-ignored)
│   ├── whitelist.json
│   ├── regions.json
│   └── *_cache_state.json
│
├── docs/                       # Документация
└── scripts/                    # Вспомогательные скрипты
```

---

## Flow: Регистрация пользователя

```
┌──────────────────┐
│  Пользователь    │
│  пишет /start    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌──────────────────┐
│  Есть в          │─NO─►│ Запрос рабочего  │
│  whitelist?      │     │ никнейма (stage) │
└────────┬─────────┘     └────────┬─────────┘
         │ YES                    │
         ▼                        ▼
┌──────────────────┐     ┌──────────────────┐
│  is_approved?    │     │ Сохранение в     │
│                  │     │ whitelist.json   │
└────────┬─────────┘     │ is_approved=false│
    YES  │  NO           └────────┬─────────┘
         │   │                    │
         │   ▼                    ▼
         │  ┌──────────────────┐  │
         │  │ "Ожидайте        │  │
         │  │  одобрения"      │  │
         │  └──────────────────┘  │
         │                        ▼
         │           ┌──────────────────────┐
         │           │ Уведомление ADMIN_ID │
         │           │ [Одобрить][Отклонить]│
         │           └──────────┬───────────┘
         │                      │
         │                      ▼
         │           ┌──────────────────────┐
         │           │ is_approved = true   │
         │           └──────────┬───────────┘
         │                      │
         ▼◄─────────────────────┘
┌──────────────────┐
│   ГЛАВНОЕ МЕНЮ   │
│                  │
│ • VK  • Mamba    │
│ • OK  • Почты    │
│ • Номера • Прокси│
└──────────────────┘
```

---

## Flow: Выдача аккаунтов

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Ресурс    │───►│   Регион    │───►│  Количество │───►│ Пол/Тип    │
│ VK/Mamba/OK │    │ 495/812/... │    │    1-5      │    │ М/Ж/Любой  │
└─────────────┘    └─────────────┘    └─────────────┘    └──────┬──────┘
                                                                │
                    ┌───────────────────────────────────────────┘
                    ▼
         ┌─────────────────────┐
         │   AccountCache      │
         │                     │
         │  1. Берёт из        │
         │     available       │
         │  2. Переносит в     │
         │     pending         │
         │  3. Возвращает      │
         │     аккаунт         │
         └──────────┬──────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │  Отправка юзеру:    │
         │                     │
         │  login: user@mail   │
         │  password: ***      │
         │  [Блок][Хороший]    │
         │  [Дефектный]        │
         └──────────┬──────────┘
                    │
        ┌───────────┼───────────┐
        ▼           ▼           ▼
   ┌────────┐  ┌────────┐  ┌────────┐
   │  Блок  │  │Хороший │  │Дефект  │
   └───┬────┘  └───┬────┘  └───┬────┘
       │           │           │
       ▼           ▼           ▼
   ┌────────┐  ┌────────────────────┐
   │Замена? │  │ Запись в таблицу   │
   │[Да/Нет]│  │ "Выданные" + цвет  │
   └────────┘  └────────────────────┘
```

---

## Система кэширования

### Трёхуровневый кэш

```
┌─────────────────────────────────────────────────────────────────┐
│                        GOOGLE SHEETS                             │
│                     (Таблица "База")                             │
└───────────────────────────┬─────────────────────────────────────┘
                            │ Загрузка (batch)
                            │ Удаление из таблицы
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                         AVAILABLE                                │
│                     (deque, готовы к выдаче)                     │
│                                                                  │
│   { "vk_none": [acc1, acc2, acc3, ...],                         │
│     "mamba_male": [acc4, acc5, ...],                            │
│     "gmail_any": [email1, email2, ...] }                        │
└───────────────────────────┬─────────────────────────────────────┘
                            │ issue() - выдача
                            │ popleft()
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                          PENDING                                 │
│                  (ждут feedback от юзера)                        │
│                                                                  │
│   { "acc_abc123": PendingAccount(login, issued_at, ...) }       │
│                                                                  │
│   ⏱ Таймаут 10 минут → автоподтверждение "Хороший"              │
└───────────────────────────┬─────────────────────────────────────┘
                            │ confirm_feedback()
                            │ good / block / defect
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                       WRITE_BUFFER                               │
│                  (ждут записи в таблицу)                         │
│                                                                  │
│   { "vk_none": [IssuedAccount(login, status, region, ...)] }    │
│                                                                  │
│   ⏱ Каждые 30 сек → batch запись в "Выданные"                   │
└───────────────────────────┬─────────────────────────────────────┘
                            │ write_to_sheet()
                            │ batch_update()
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                        GOOGLE SHEETS                             │
│                    (Таблица "Выданные")                          │
│                                                                  │
│   + Цветовое кодирование статусов:                              │
│     🟢 Хороший   🔴 Блок   🟡 Дефектный                          │
└─────────────────────────────────────────────────────────────────┘
```

### Преимущества

| Аспект | Решение |
|--------|---------|
| **Скорость** | Мгновенная выдача из памяти |
| **Надёжность** | Персистентность в JSON файлах |
| **API лимиты** | Batch операции, 1.5 req/s |
| **Конкуренция** | asyncio.Lock на каждый ресурс |
| **Восстановление** | Автозагрузка состояния при старте |

---

## Технические решения

### 1. Rate Limiting для Google Sheets API

```python
class SheetsRateLimiter:
    """
    Google API лимиты:
    - 100 запросов за 100 секунд на пользователя
    - 500 запросов за 100 секунд на проект
    """

    max_concurrent = 10        # Параллельные запросы
    requests_per_second = 1.5  # ~90 за минуту

    # Использование:
    async with sheets_rate_limiter:
        await worksheet.get_all_values()
```

### 2. Автоподтверждение (Auto-feedback)

```python
# При запросе номеров проверяем старые pending
async def _cleanup_expired_pending(self):
    now = time.time()

    # Кулдаун 1 час между проверками
    if now - self._last_cleanup < 3600:
        return

    # Номера старше 10 минут → статус "Рабочий"
    for pending in self._pending.values():
        if now - pending.issued_at > 600:
            await self.update_status(pending.number, "working")
```

### 3. Освобождение устаревших номеров

```python
# При today_only=True, устаревшие номера возвращаются в таблицу
async def _insert_numbers_by_date(self, numbers):
    """
    Вставляет номера ПОСЛЕ последнего номера с той же датой.

    Пример:
    21.12.25  79991234567   ← существующий
    21.12.25  79991234568   ← ВСТАВЛЯЕМ СЮДА
    22.12.25  79991234569   ← сегодняшние
    """
```

### 4. Персистентность состояния

```python
# Автосохранение каждые 60 секунд
async def _save_state_loop(self):
    while True:
        await asyncio.sleep(60)
        self.save_state()  # → data/cache_state.json

# Восстановление при старте
async def preload(self):
    self.load_state()  # ← data/cache_state.json
```

---

## Система прокси

### Добавление прокси

```
┌────────────┐    ┌─────────────────┐    ┌────────────────┐
│ Тип прокси │───►│ Ввод строки     │───►│ Выбор ресурсов │
│ HTTP/SOCKS5│    │ ip:port:user:pwd│    │ [✓] VK [✓] OK  │
└────────────┘    └─────────────────┘    └───────┬────────┘
                                                 │
                                                 ▼
                                        ┌────────────────┐
                                        │ Срок действия  │
                                        │ 5/10/15/30 дн  │
                                        └───────┬────────┘
                                                │
                                                ▼
                                        ┌────────────────┐
                                        │ Сохранение в   │
                                        │ Google Sheets  │
                                        └────────────────┘
```

### Получение прокси с резервированием

```
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│ Выбор ресурсов │───►│ Выбор страны   │───►│ Выбор прокси   │
│ [✓] VK [✓] OK  │    │ 🇷🇺 🇺🇸 🇩🇪     │    │ (пагинация)    │
└────────────────┘    └────────────────┘    └───────┬────────┘
                                                    │
                      ┌─────────────────────────────┘
                      ▼
              ┌───────────────────┐
              │ РЕЗЕРВИРОВАНИЕ    │
              │ TTL = 5 минут     │
              │                   │
              │ Прокси недоступен │
              │ другим юзерам     │
              └─────────┬─────────┘
                        │
           ┌────────────┼────────────┐
           ▼            ▼            ▼
      ┌────────┐   ┌────────┐   ┌────────┐
      │Отменить│   │Получить│   │Таймаут │
      └───┬────┘   └───┬────┘   └───┬────┘
          │            │            │
          ▼            ▼            ▼
      Освободить   Подтвердить   Освободить
      резерв       использование  автоматически
```

---

## Статистика

### Доступные отчёты

| Категория | Фильтры | Метрики |
|-----------|---------|---------|
| **Аккаунты** | Ресурс → Пол → Регион → Период | Выдано, Блок, Хороший, Дефект |
| **Почты** | Ресурс → Тип → Регион → Период | Выдано, по статусам |
| **Номера** | Регион → Период | Выдано, Рабочий, Сброс, Зареган |

### Периоды
- За день
- За неделю
- За месяц

### Детализация
- Общая статистика
- По регионам (с разбивкой)

---

## Безопасность

### Whitelist система

```
┌─────────────────────────────────────────────┐
│              WhitelistMiddleware             │
│                                              │
│   Каждый запрос проверяется:                │
│                                              │
│   1. /start - ПРОПУСК (регистрация)         │
│   2. RegistrationStates - ПРОПУСК           │
│   3. Остальное:                              │
│      └─► whitelist.json                      │
│          └─► is_approved == true?            │
│              ├─► YES: Доступ разрешён        │
│              └─► NO:  "Доступ запрещён"      │
└─────────────────────────────────────────────┘
```

### Файл whitelist.json

```json
{
  "123456789": {
    "stage": "worker_nickname",
    "is_approved": true
  },
  "987654321": {
    "stage": "new_user",
    "is_approved": false
  }
}
```

---

## Админ-команды

| Команда | Описание |
|---------|----------|
| `/whitelist` | Список всех пользователей |
| `/whitelist_remove <id>` | Удалить пользователя |
| `/add_region <код>` | Добавить регион |
| `/remove_region <код>` | Удалить регион |
| `/regions` | Список регионов |
| `/numbers_today_mod` | Режим выдачи номеров |
| `/buffer_clear` | Очистка буферов |
| `/buffer_release` | Освобождение буферов |

---

## Конфигурация

### Переменные окружения (.env)

```bash
# Telegram
BOT_TOKEN=123456:ABC-DEF...
ADMIN_ID=123456789

# Google Sheets
GOOGLE_CREDENTIALS_JSON={"type":"service_account",...}
SPREADSHEET_ACCOUNTS=1abc...xyz
SPREADSHEET_ISSUED=1def...uvw

# Опционально
REGIONS=495,812,383,343
```

### Параметры кэширования

```python
LOAD_BATCH_SIZE = 30        # Загрузка за раз
REFILL_THRESHOLD = 10       # Триггер пополнения
WRITE_BUFFER_INTERVAL = 30  # Интервал записи (сек)
AUTO_CONFIRM_TIMEOUT = 600  # Автоподтверждение (сек)
STATE_SAVE_INTERVAL = 60    # Автосохранение (сек)
```

---

## Технологический стек

| Компонент | Технология |
|-----------|------------|
| **Язык** | Python 3.12 |
| **Telegram API** | aiogram 3.x |
| **Google Sheets** | gspread + gspread_asyncio |
| **Асинхронность** | asyncio, aiohttp |
| **FSM** | aiogram.fsm |
| **Хранение** | JSON файлы (локальное) |
| **Деплой** | Render.com / VPS |

---

## Заключение

**Account Bot** — это production-ready решение для автоматизации распределения ресурсов с:

- **Высокой производительностью** благодаря in-memory кэшированию
- **Надёжностью** через персистентность и автовосстановление
- **Масштабируемостью** с учётом API лимитов
- **Безопасностью** через whitelist авторизацию
- **Удобством** с интуитивным Telegram-интерфейсом

---

*Создано с использованием Claude Code*
